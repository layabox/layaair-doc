# CacheAs静态缓存优化

​        在属性设置器中的其他通用属性里，我们介绍了cacheAs缓存优化概念和功能作用。也推荐开发者在UI界面制作时尽量都合理的使用它，下面我们将用一个UI实例展示cacheAs在项目中的运用，同时我们对cacheAs的使用前后作出数据分析，以供开发者们参考。

​	我们先看一下未使用CacheAs缓存功能的情况，如图1所示。在webgl的调试模式下，可以看到UI中每帧的Sprite渲染节点数为23个，DrawCall渲染次数为8，Shader材质提交次数为7次。（*该数据在优化后可以用于性能优化对比*）

 ![imgage](img/1.png)<br/>
（图1）



## 1、cacheAs为normal的缓存优化 

当我们使用cacheAs时，将cacheAs设置为“normal”模式，DrawCall与Shader未变，Sprite节点数由23降低到了8，节点渲染性能上优化了近3倍。如图2所示。

![图2](img/2.png) <br /> (图2)

**Tips**：

当cacheAs属性值为"normal"时，Canvas下进行画布缓存，webgl模式下进行命令缓存。该模式性能优化中等，它能减少每帧渲染的节点数，但不会减少DrawCall数和Shader数。





## 2、cacheAs为bitmap的缓存优化 

当我们使用cacheAs时，并将cacheAs设置为“bitmap”模式。Sprite节点数为8，DrawCall降到了1，Shader数降到了0。只是修改了一个配置，性能上比不用cacheAs优化了十倍以上。效果如图3所示。

![图3](img/3.png) <br /> (图3)

**Tips**：

Canvas下依然是画布缓存，在webgl模式下使用renderTarget缓存，相当于缓存成静态位图提交显卡渲染。这里需要注意的是，webGL下renderTarget缓存模式有2048大小限制，超出2048会额外增加内存开销。另外，不断重绘时开销也比较大，但是会减少drawcall，渲染性能最高。 

在本篇文档中，我们的示例UI比较简单，对于一些大型的游戏，节点数超过了50的UI不在少数，采用cacheAs缓存技术以后，渲染性能会提高很多倍。





## 3、如何选择缓存优化

### 3.1 内存与CPU的考量

#### bitmap模式与内存增加

在上例中我们也可以看到，当使用bitmap位图缓存模式后，在CurMem内存数值上有所增加，由之前的17.22M增加到了18.27M，因为缓存位图时消耗了部分内存，但只要UI的宽高不是很大，增加的内存也不会太大。

#### 频繁刷新的CPU消耗

最需要注意的是UI是否会频繁的刷新，如果很频繁，CPU的损耗会很大，因为缓存位图时子对象一旦发生改变，那么引擎会自动重新缓存位图，缓存位图的过程会消耗CPU。

那么选择使用cacheAs的normal还是bitmap模式，或者不使用cacheAs，我们需要对内存的增加与CPU消耗作为重点考量因素。



### 3.2 测试是否频繁重绘

LayaAir引擎提供的DebugPanel调试工具可以帮助大家查看游戏重绘区，在代码中增加`DebugPanel.init();` 方法 ，编译运行项目后，浏览器中会出现调试窗口，如图4所示。

![图3](img/4.png) <br /> (图4)

我们勾选“`显示当前cache重绘`”选项或“`显示所有重绘区域`”。如果UI进行重绘了，重绘区域会显示出绿色框线，绿色框的左上角显示了重绘次数与重绘时间，性能统计工具的Sprite、DrawCall等也会发生改变。

在没有鼠标操作的情况下，如果绿色线框频繁出现，说明**UI在频繁的重绘，那么最好不要用bitmap缓存模式，normal模式可以酌情考虑**。当然，还可以把UI进行分层管理，频繁更新的为一层（不使用cacheAs），不频繁更新的为一层（使用cacheAs），这种方法也能提高性能。


### 3.3 低端机型的配置因素

我们在做游戏项目时，通常会考虑到手机配置，大多数情况是游戏适应的机型越多越好，游戏测试员也会用高中低端配置的手机去测试，然后提供优化建议。那么在使用cacheAs的时候，也需要参考手机的内存、CPU大小。

对于一些低端机来说，CPU与内存不高，如果为了提高渲染性能使用了cacheAs，有可能就会出现问题。

这时开发者们就需要做取舍了，选择要性能还是要游戏机型的广度，或者取中。如果选择适应更多的低端机型，那么需要反复去测试，是否使用cacheAs，还要对比normal与bitmap模式哪种更适合，在优化性能的情况下尽量减少CPU和内存损耗。



## 4、什么情况下不能使用cacheAs

### 4.1 对象非常简单时不能使用

当对象非常简单时，比如一个字或者一个图片，设置cacheAs不但不提高性能，反而会损失性能。

### 4.2 经常变化的内容不能使用

容器内有经常变化的内容，比如容器内有一个动画或者倒计时，如果再对这个容器设置cacheAs，会损失性能。

我们可以通过查看性能统计面板中的Canvas统计信息第一个值，如果一直在变化，说明一直在重绘，在这种情况下不能使用cacheAs。